<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">
    <title>Reset Password</title>
    <!-- Ionicons for requirement status icons -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <style>
        /* --- General Styling --- */
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f4f4f4;
        }

        #reset-password-form {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Header with logo + title inline */
        #header-inline {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            justify-content: center;
            margin-bottom: 16px;
        }

        #app-logo {
            width: 50px;
            height: 50px;
            border-radius: 15px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            object-fit: contain;
        }
        
        h2 {
            color: #333;
            margin: 0;
            font-size: 0.95em; /* Slightly smaller to complement logo */
            font-weight: 600;
            letter-spacing: 0.5px;
            text-align: center; /* Center heading horizontally */
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 13px;
        }

        .password-container {
            position: relative;
            margin-bottom: 15px;
        }

        .password-container input[type="password"],
        .password-container input[type="text"] {
            padding: 9px;
            width: 100%;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding-right: 70px; 
            margin-bottom: 0;
            font-size: 14px; /* Prevent mobile zoom */
        }

        .toggle-password {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            color: #007bff; 
            font-size: 0.7em; 
            font-weight: bold;
            text-decoration: none;
            z-index: 10;
        }

        /* --- Validation Rule Styling --- */
        #validation-rules {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
            background-color: #fcfcfc;
        }

        #validation-rules p {
            font-weight: bold;
            margin-top: 0;
            margin-bottom: 5px;
            color: #444;
            font-size: 13px; /* Match label size */
        }

        #validation-rules ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        #validation-rules li {
            color: #c41e3a;
            font-size: 11.5px;
            line-height: 1.4;
            transition: color 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        #validation-rules li.met {
            color: #2e7d32;
        }

        /* --- Submit Button Styling --- */
        #reset-button {
            padding: 8px 16px; /* Smaller padding */
            width: auto; /* Wrap to text width */
            display: block; /* Allow centering */
            margin: 20px auto 0; /* Center below inputs */
            background-color: #ced4da; 
            color: #6c757d; 
            border: none;
            border-radius: 8px;
            font-size: 0.7em;
            cursor: not-allowed;
            transition: background-color 0.3s, color 0.3s;
        }

        #reset-button:enabled {
            background-color: #3b4cca; 
            color: white; 
            cursor: pointer;
        }

        /* --- Custom Success Modal --- */
        .success-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex; /* Center horizontally and vertically */
            align-items: center;
            justify-content: center;
            z-index: 1000;
            font-family: Arial, sans-serif;
        }

        .success-modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            text-align: center;
            width: 65%; /* smaller width on mobile */
            max-width: 360px; /* smaller cap on larger screens */
            margin: 20px;
        }

        .success-modal h2 {
            color: #3b4cca;
            margin: 0 0 12px 0;
            font-size: 0.95em; /* match page heading size */
            font-weight: 600;
        }

        .success-modal p {
            color: #666;
            margin: 0 0 20px 0;
            line-height: 1.5;
            font-size: 14px; /* body text size */
        }

        .success-modal-button {
            background: #3b4cca;
            color: white;
            border: none;
            display: inline-block; /* size to content */
            padding: 8px 16px; /* button padding */
            border-radius: 6px; /* slightly smaller radius */
            font-size: 14px; /* button text size */
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .success-modal-button:hover {
            background: #2e3a9e;
        }
    </style>
</head>
<body>

    <form id="reset-password-form">
        <div id="header-inline">
            <img src="logo.png" alt="Logo" id="app-logo" style="width: 50px; height: 50px; border-radius: 15px;">
            <h2>Reset Password</h2>
        </div>

        <div>
            <label for="new-password">New Password</label>
            <div class="password-container">
                <input type="password" id="new-password" placeholder="Enter new password">
                <a href="#" class="toggle-password" onclick="togglePasswordVisibility('new-password', this); return false;">
                    Show
                </a>
            </div>
        </div>

        <div>
            <label for="confirm-password">Confirm Password</label>
            <div class="password-container">
                <input type="password" id="confirm-password" placeholder="Confirm new password">
                <a href="#" class="toggle-password" onclick="togglePasswordVisibility('confirm-password', this); return false;">
                    Show
                </a>
            </div>
        </div>

        <div id="validation-rules">
            <p>Password requirements</p>
            <ul>
                <li id="rule-min-max"><ion-icon id="icon-min-max" name="close-circle" style="color:#c41e3a;font-size:16px;"></ion-icon> Minimum 8 and maximum 20 characters</li>
                <li id="rule-uppercase"><ion-icon id="icon-uppercase" name="close-circle" style="color:#c41e3a;font-size:16px;"></ion-icon> At least 1 uppercase letter (A-Z)</li>
                <li id="rule-lowercase"><ion-icon id="icon-lowercase" name="close-circle" style="color:#c41e3a;font-size:16px;"></ion-icon> At least 1 lowercase letter (a-z)</li>
                <li id="rule-number"><ion-icon id="icon-number" name="close-circle" style="color:#c41e3a;font-size:16px;"></ion-icon> At least 1 number (0-9)</li>
                <li id="rule-special"><ion-icon id="icon-special" name="close-circle" style="color:#c41e3a;font-size:16px;"></ion-icon> At least 1 special character (!@#$%^&*)</li>
                <li id="rule-match"><ion-icon id="icon-match" name="close-circle" style="color:#c41e3a;font-size:16px;"></ion-icon> Passwords match</li>
            </ul>
        </div>

        <button type="submit" id="reset-button" disabled>Reset Password</button>
        
        <!-- Loading indicator -->
        <div id="loading-indicator" style="display: none; text-align: center; margin-top: 20px;">
            <div style="color: #3b4cca; font-weight: bold;">üîÑ Resetting password...</div>
        </div>
        
        <!-- Success message -->
        <div id="success-message" style="display: none; text-align: center; margin-top: 20px; padding: 15px; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; color: #155724;">
            <div style="font-weight: bold; margin-bottom: 10px;">‚úÖ Password Reset Successful!</div>
            <div>Redirecting to login page...</div>
        </div>
        
        <!-- Error message -->
        <div id="error-message" style="display: none; text-align: center; margin-top: 20px; padding: 15px; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; color: #721c24;">
            <div style="font-weight: bold; margin-bottom: 10px;">‚ùå Password Reset Failed</div>
            <div id="error-text"></div>
        </div>
    </form>

    <script>
        const newPasswordField = document.getElementById('new-password');
        const confirmPasswordField = document.getElementById('confirm-password');
        const resetButton = document.getElementById('reset-button');

        // Rule elements from the HTML
        const rules = {
            minMax: document.getElementById('rule-min-max'),
            uppercase: document.getElementById('rule-uppercase'),
            lowercase: document.getElementById('rule-lowercase'),
            number: document.getElementById('rule-number'),
            special: document.getElementById('rule-special'),
            match: document.getElementById('rule-match')
        };

        // Object to track the current status of each validation rule
        const validationStatus = {
            minMax: false,
            uppercase: false,
            lowercase: false,
            number: false,
            special: false,
            match: false
        };

        /**
         * Toggles the visibility of a password field and updates the text link.
         */
        function togglePasswordVisibility(fieldId, toggleLink) {
            const passwordField = document.getElementById(fieldId);

            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                toggleLink.textContent = 'Hide'; 
            } else {
                passwordField.type = 'password';
                toggleLink.textContent = 'Show'; 
            }
        }

        // --- Standard Validation Logic ---
        
        // Map rule keys to icon elements
        const ruleIcons = {
            minMax: document.getElementById('icon-min-max'),
            uppercase: document.getElementById('icon-uppercase'),
            lowercase: document.getElementById('icon-lowercase'),
            number: document.getElementById('icon-number'),
            special: document.getElementById('icon-special'),
            match: document.getElementById('icon-match')
        };

        function updateRuleUI(element, isValid, key) {
            if (isValid) {
                element.classList.add('met');
                if (ruleIcons[key]) {
                    ruleIcons[key].setAttribute('name', 'checkmark-circle');
                    ruleIcons[key].style.color = '#2e7d32';
                }
            } else {
                element.classList.remove('met');
                if (ruleIcons[key]) {
                    ruleIcons[key].setAttribute('name', 'close-circle');
                    ruleIcons[key].style.color = '#c41e3a';
                }
            }
        }

        function updateResetButtonStatus() {
            const allRulesMet = Object.values(validationStatus).every(status => status === true);
            resetButton.disabled = !allRulesMet;
        }

        function validateNewPassword() {
            const password = newPasswordField.value;

            // Regex checks
            validationStatus.minMax = password.length >= 8 && password.length <= 20;
            validationStatus.uppercase = /[A-Z]/.test(password);
            validationStatus.lowercase = /[a-z]/.test(password);
            validationStatus.number = /[0-9]/.test(password);
            validationStatus.special = /[!@#$%^&*]/.test(password);

            // Update UI for all rules except match
            updateRuleUI(rules.minMax, validationStatus.minMax, 'minMax');
            updateRuleUI(rules.uppercase, validationStatus.uppercase, 'uppercase');
            updateRuleUI(rules.lowercase, validationStatus.lowercase, 'lowercase');
            updateRuleUI(rules.number, validationStatus.number, 'number');
            updateRuleUI(rules.special, validationStatus.special, 'special');

            validatePasswordMatch();
            updateResetButtonStatus();
        }

        function validatePasswordMatch() {
            const newPassword = newPasswordField.value;
            const confirmPassword = confirmPasswordField.value;

            validationStatus.match = (newPassword.length > 0 && newPassword === confirmPassword);
            updateRuleUI(rules.match, validationStatus.match, 'match');

            updateResetButtonStatus();
        }

        // --- Event Listeners ---
        newPasswordField.addEventListener('input', validateNewPassword);
        confirmPasswordField.addEventListener('input', validatePasswordMatch);

        // Initial checks
        validateNewPassword();
        validatePasswordMatch();

        // Handle form submission with Firebase
        document.getElementById('reset-password-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            if (resetButton.disabled) {
                alert('Cannot submit. Please meet all password requirements first.');
                return;
            }

            const newPassword = newPasswordField.value;
            
            // Show loading state
            resetButton.textContent = 'Resetting...';
            resetButton.disabled = true;
            
            try {
                // For testing without reset code (preview mode)
                const urlParams = new URLSearchParams(window.location.search);
                const resetCode = urlParams.get('oobCode');
                
                if (!resetCode) {
                    // Simulate success for testing
                    setTimeout(() => {
                        resetButton.textContent = 'Reset Password';
                        resetButton.disabled = false;
                        
                        // Show custom success modal
                        showSuccessModal();
                    }, 2000);
                    return;
                }
                
                // Real Firebase password reset
                await resetPasswordWithFirebase(resetCode, newPassword);
                
            } catch (error) {
                console.error('Password reset failed:', error);
                resetButton.textContent = 'Reset Password';
                resetButton.disabled = false;
                
                // Show specific error message for password history
                if (error.message && error.message.includes('previously used password')) {
                    alert('‚ùå ' + error.message);
                } else {
                    alert('‚ùå Failed to reset password. Please try again or request a new reset link.');
                }
            }
        });

        // Custom success modal function
        function showSuccessModal() {
            // Create modal HTML
            const modal = document.createElement('div');
            modal.className = 'success-modal';
            modal.innerHTML = `
                <div class="success-modal-content">
                    <div style="margin-bottom: 20px;">
                        <img src="logo.png" alt="Logo" style="width: 50px; height: 50px; border-radius: 12px; object-fit: contain;">
                    </div>
                    <h3>Password Reset Complete!</h3>
                    <p>You can now log in using your new password in the app.</p>
                    <button class="success-modal-button" onclick="closeModal()">OK</button>
                </div>
            `;
            
            // Add to page
            document.body.appendChild(modal);
            
            // Close function
            window.closeModal = function() {
                // Try to close the browser/tab
                try {
                    window.close();
                } catch (e) {
                    // Fallback: show closing message
                    modal.innerHTML = `
                        <div class="success-modal-content">
                            <div style="margin-bottom: 20px;">
                                <img src="logo.png" alt="Logo" style="width: 50px; height: 50px; border-radius: 12px; object-fit: contain;">
                            </div>
                            <h2>Password Reset Complete!</h2>
                            <p>You can now log in using your new password.</p>
                            <p style="color: #888; font-size: 14px; margin-top: 20px;">You can safely close this browser and return to the app.</p>
                        </div>
                    `;
                }
            };
        }

        // Password hashing function using Web Crypto API
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Check if password was used before
        async function checkPasswordHistory(userEmail, newPassword) {
            try {
                const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                
                // Get user document
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('email', '==', userEmail));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    const userData = userDoc.data();
                    const passwordHistory = userData.passwordHistory || [];
                    
                    // Hash the new password to compare with history
                    const newPasswordHash = await hashPassword(newPassword);
                    
                    // Check if password was used before (check last 5 passwords)
                    if (passwordHistory.includes(newPasswordHash)) {
                        throw new Error('You cannot reuse a previously used password. Please choose a different password.');
                    }
                }
            } catch (error) {
                if (error.message.includes('previously used password')) {
                    throw error; // Re-throw our custom error
                }
                console.warn('Error checking password history:', error);
                // Don't block password reset if history check fails for other reasons
            }
        }

        // Firebase password reset function
        async function resetPasswordWithFirebase(resetCode, newPassword) {
            // Dynamic import Firebase modules to avoid breaking existing code
            const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
            const { getAuth, confirmPasswordReset, verifyPasswordResetCode } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
            const { getFirestore, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            const firebaseConfig = {
                apiKey: "AIzaSyAOC8S6aOGvfnUzp0Twb-7O727Un9FoUGE",
                authDomain: "internet-of-tsiken-690dd.firebaseapp.com",
                projectId: "internet-of-tsiken-690dd",
                storageBucket: "internet-of-tsiken-690dd.appspot.com",
                messagingSenderId: "296742448098",
                appId: "1:296742448098:web:8163021d84af262c6527bb",
                measurementId: "G-FEWSJPB1Z1"
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // First, get the user's email from the reset code
            const userEmail = await verifyPasswordResetCode(auth, resetCode);
            
            // Check password history before allowing reset
            await checkPasswordHistory(userEmail, newPassword);
            
            // Confirm password reset
            await confirmPasswordReset(auth, resetCode, newPassword);
            
            // After successful password reset, set flag in Firestore
            try {
                // Find user document by email and update password reset flag
                const { collection, query, where, getDocs, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                
                // Query users collection to find user by email
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('email', '==', userEmail));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    const userRef = doc(db, 'users', userDoc.id);
                    
                    // Get current password history
                    const userData = userDoc.data();
                    const passwordHistory = userData.passwordHistory || [];
                    
                    // Add current password to history (hash it for security)
                    const passwordHash = await hashPassword(newPassword);
                    const updatedHistory = [passwordHash, ...passwordHistory.slice(0, 4)]; // Keep last 5 passwords
                    
                    // Set password reset flag with current timestamp and update password history
                    await updateDoc(userRef, {
                        passwordResetAt: new Date(),
                        mustShowPasswordUpdated: true,
                        passwordHistory: updatedHistory
                    });
                    
                    console.log('Password reset flag set for user:', userEmail);
                } else {
                    console.log('User document not found for email:', userEmail);
                }
            } catch (error) {
                console.error('Error updating password reset flag:', error);
                // Don't fail the password reset if we can't update the flag
            }
            
            // Success
            resetButton.textContent = 'Reset Password';
            resetButton.disabled = false;
            
            // Show custom success modal
            showSuccessModal();
        }
    </script>
</body>
</html>